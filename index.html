<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Steve's Macro Meal Planner</title>
<meta name="description" content="ADHD-optimized macro meal planner with food dropdowns, dynamic math, fat-per-meal badges, and daily targets.">
<style>
  /* ====== RESET & BASE ====== */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  :root {
    --bg: #111827;
    --panel: #1f2937;
    --panel-2: #0f172a;
    --ink: #ffffff;
    --muted: #9ca3af;
    --border: #374151;
    --accent: #60a5fa;
    --ok: #4ade80;
    --warn: #f59e0b;
    --bad: #ef4444;
    --train: #facc15;
    --rest: #34d399;
    --busy: #60a5fa;
  }

  html, body {
    width: 100%;
    height: 100vh;
    overflow: hidden;
  }

  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--ink);
    padding: 8px;
    display: flex;
    flex-direction: column;
  }

  .container {
    flex: 1;
    max-width: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .title {
    font-weight: 800;
    text-align: center;
    margin: 0.15rem 0 0.5rem;
    font-size: 1.1rem;
  }

  /* ====== TOOLBAR ====== */
  .toolbar {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    padding: 0.4rem;
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    background: var(--panel);
    margin-bottom: 8px;
  }

  .toolbar .group {
    display: flex;
    gap: 0.4rem;
    align-items: center;
  }

  .btn {
    padding: 0.35rem 0.6rem;
    border: 1px solid var(--border);
    background: var(--panel);
    color: #fff;
    border-radius: 0.4rem;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .btn:hover {
    background: #374151;
  }

  .btn.primary {
    background: #3b82f6;
    border-color: #2563eb;
  }

  .btn.primary:hover {
    background: #2563eb;
  }

  .btn.ghost {
    background: transparent;
  }

  .btn.danger {
    background: #ef4444;
    border-color: #dc2626;
  }

  .btn.danger:hover {
    background: #dc2626;
  }

  .pill {
    padding: 0.2rem 0.5rem;
    border-radius: 999px;
    font-weight: 700;
    font-size: 0.8rem;
  }

  .pill.train {
    background: rgba(250,204,21,0.15);
    border: 1px solid #a16207;
    color: var(--train);
  }

  .pill.rest {
    background: rgba(52,211,153,0.15);
    border: 1px solid #047857;
    color: var(--rest);
  }

  .pill.busy {
    background: rgba(96,165,250,0.15);
    border: 1px solid #1d4ed8;
    color: var(--busy);
  }

  label.small {
    color: var(--muted);
    font-size: 0.8rem;
  }

  /* ====== MAIN GRID ====== */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr 280px;
    gap: 10px;
    flex: 1;
    overflow: hidden;
  }

  .meals {
    grid-column: 1 / span 2;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    overflow-y: auto;
    padding-right: 4px;
  }

  /* ====== MEAL CARDS ====== */
  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    padding: 10px;
    height: fit-content;
  }

  .card h3 {
    font-size: 0.95rem;
    font-weight: 800;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .rows {
    display: grid;
    gap: 6px;
  }

  .row {
    display: grid;
    grid-template-columns: minmax(180px, 1fr) auto 1fr 36px;
    gap: 6px;
    align-items: center;
  }

  .row > * {
    min-width: 0;
  }

  .remove {
    justify-self: end;
    padding: 0.25rem 0.4rem;
    font-size: 0.9rem;
  }

  .sub {
    color: var(--muted);
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chip {
    font-weight: 600;
    padding: 0.15rem 0.4rem;
    border-radius: 0.3rem;
    font-size: 0.75rem;
  }

  .chip.ok {
    background: rgba(74,222,128,0.12);
    color: var(--ok);
    border: 1px solid #16a34a;
  }

  .chip.warn {
    background: rgba(245,158,11,0.12);
    color: var(--warn);
    border: 1px solid #b45309;
  }

  .chip.bad {
    background: rgba(239,68,68,0.12);
    color: var(--bad);
    border: 1px solid #b91c1c;
  }

  .add-row {
    margin-top: 4px;
    font-size: 0.8rem;
  }

  .fat-note {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .fat-note b {
    color: #fff;
  }

  /* Food picker and stepper */
  .picker {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .picker select {
    flex: 1 1 auto;
    background: #fff;
    color: #111;
    border: 1px solid #d1d5db;
    border-radius: 0.3rem;
    padding: 0.35rem;
    font-size: 0.8rem;
  }

  .stepper {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .stepper input {
    width: 60px;
    text-align: center;
    background: #fff;
    color: #111;
    border: 1px solid #d1d5db;
    border-radius: 0.3rem;
    padding: 0.3rem;
    font-size: 0.8rem;
  }

  .stepper .u {
    color: var(--muted);
    font-size: 0.75rem;
  }

  .stepper .pm {
    width: 26px;
    height: 26px;
    border-radius: 0.3rem;
    border: 1px solid var(--border);
    background: var(--panel-2);
    color: #fff;
    cursor: pointer;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .stepper .pm:hover {
    background: var(--border);
  }

  select, input[type="number"] {
    background: #fff;
    color: #111;
    border: 1px solid #d1d5db;
    border-radius: 0.3rem;
    padding: 0.35rem;
    font-size: 0.8rem;
  }

  select:focus, input:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--accent);
  }

  /* ====== SIDEBAR ====== */
  .sidebar {
    display: grid;
    gap: 10px;
    height: 100%;
    overflow-y: auto;
  }

  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    padding: 10px;
  }

  .totals h4 {
    font-weight: 800;
    margin-bottom: 6px;
    font-size: 0.95rem;
  }

  .kpi {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 6px;
    margin: 6px 0;
  }

  .kpi .num {
    font-weight: 900;
  }

  .bar {
    height: 10px;
    background: #0b1324;
    border: 1px solid #172554;
    border-radius: 999px;
    overflow: hidden;
  }

  .bar > span {
    display: block;
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #22c55e);
    width: 0%;
    transition: width 0.3s ease;
  }

  .remain {
    color: var(--muted);
    font-size: 0.75rem;
    text-align: right;
  }

  .targets {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    margin-top: 6px;
  }

  .targets div {
    background: var(--panel-2);
    border: 1px solid var(--border);
    padding: 4px;
    border-radius: 0.4rem;
    text-align: center;
  }

  .targets strong {
    display: block;
    font-size: 0.95rem;
  }

  .targets small {
    font-size: 0.7rem;
  }

  .save-row {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }

  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  ::-webkit-scrollbar-track {
    background: var(--panel-2);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--accent);
  }

  /* Responsive adjustments */
  @media (max-width: 1024px) {
    .grid {
      grid-template-columns: 1fr;
    }
    
    .meals {
      grid-column: 1;
      grid-template-columns: 1fr;
    }
    
    .sidebar {
      display: none;
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="title">Steve's Macro Meal Planner</div>

  <div class="toolbar" role="toolbar" aria-label="Actions">
    <div class="group">
      <label class="small" for="dayType">Day Type</label>
      <select id="dayType" aria-label="Select day type">
        <option value="training">Training Day — 200P / 340C / 85F (~3000 kcal)</option>
        <option value="rest">Rest Day — 200P / 260C / 85F (~2700 kcal)</option>
        <option value="busy">Busy Day — 200P / 320C / 85F (~2900 kcal)</option>
      </select>
      <span id="dayPill" class="pill train" aria-live="polite">TRAINING</span>
    </div>
    <div class="group">
      <button class="btn ghost" id="importBtn" title="Paste JSON to load">Import</button>
      <button class="btn" id="exportBtn" title="Copy JSON to clipboard">Export</button>
      <button class="btn" id="downloadBtn" title="Download JSON file">Download</button>
      <button class="btn danger" id="resetBtn">Reset</button>
    </div>
  </div>

  <div class="grid">
    <!-- MEALS -->
    <div class="meals" id="meals" aria-live="polite"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Totals and Save">
      <div class="panel totals">
        <h4>Daily Totals</h4>

        <div class="kpi">
          <div>
            <span style="color:var(--muted)">Protein</span>
            <div class="bar"><span id="barP"></span></div>
          </div>
          <div class="remain">
            <span id="totP">0 g</span><br>
            <small id="remP">0 g left</small>
          </div>
        </div>

        <div class="kpi">
          <div>
            <span style="color:var(--muted)">Carbs</span>
            <div class="bar"><span id="barC"></span></div>
          </div>
          <div class="remain">
            <span id="totC">0 g</span><br>
            <small id="remC">0 g left</small>
          </div>
        </div>

        <div class="kpi">
          <div>
            <span style="color:var(--muted)">Fat</span>
            <div class="bar"><span id="barF"></span></div>
          </div>
          <div class="remain">
            <span id="totF">0 g</span><br>
            <small id="remF">0 g left</small>
          </div>
        </div>

        <div class="kpi">
          <div>
            <span style="color:var(--muted)">Calories</span>
            <div class="bar"><span id="barK"></span></div>
          </div>
          <div class="remain">
            <span id="totK">0 kcal</span><br>
            <small id="remK">0 kcal left</small>
          </div>
        </div>

        <div class="targets">
          <div>
            <small style="color:var(--muted)">Target P</small>
            <strong id="tgP">200</strong>
            <small style="color:var(--muted)">g</small>
          </div>
          <div>
            <small style="color:var(--muted)">Target C</small>
            <strong id="tgC">340</strong>
            <small style="color:var(--muted)">g</small>
          </div>
          <div>
            <small style="color:var(--muted)">Target F</small>
            <strong id="tgF">85</strong>
            <small style="color:var(--muted)">g</small>
          </div>
          <div>
            <small style="color:var(--muted)">Target</small>
            <strong id="tgK">3000</strong>
            <small style="color:var(--muted)">kcal</small>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="save-row">
          <button class="btn primary" id="saveBtn">Save to Browser</button>
          <button class="btn" id="clearSaveBtn">Clear Save</button>
        </div>
        <p style="color:var(--muted);font-size:0.7rem;margin-top:4px">State stored in localStorage.</p>
      </div>

      <div class="panel">
        <b style="font-size:0.85rem">Fat per meal</b>
        <p style="color:var(--muted);font-size:0.7rem;margin-top:2px">Green ≤20g, amber 20-25g, red >25g</p>
      </div>
    </aside>
  </div>
</div>

<script>
// ====== FOOD DATABASE ======
const FOOD_DB = [
  // Dairy
  {k:"kefir_1c",        name:"Kefir (plain, 1 cup)",                        cat:"Dairy",  P:9,  C:12, F:3,  K:120},
  {k:"greek2_3q",       name:"Greek Yogurt 2% (¾ cup / 170g)",              cat:"Dairy",  P:15, C:6,  F:3,  K:120},
  {k:"cottage2_half",   name:"Cottage Cheese 2% (½ cup)",                   cat:"Dairy",  P:12, C:5,  F:2,  K:100},
  {k:"skyr_1c",         name:"Skyr (1 cup)",                                cat:"Dairy",  P:20, C:15, F:1,  K:150},
  {k:"fairlife_1c",     name:"Fairlife Milk (1 cup)",                        cat:"Dairy",  P:13, C:6,  F:2.5,K:80},
  {k:"whey_iso",        name:"Whey Isolate (1 scoop, optional)",            cat:"Dairy",  P:25, C:2,  F:1,  K:120},

  // Proteins
  {k:"chicken_3oz",     name:"Chicken Breast (cooked, 3 oz)",               cat:"Protein",P:26, C:0,  F:3,  K:140},
  {k:"turkey_3oz",      name:"Turkey Breast Deli (3 oz)",                   cat:"Protein",P:21, C:2,  F:1.5,K:110},
  {k:"salmon_5oz",      name:"Salmon (cooked, 5 oz)",                       cat:"Protein",P:34, C:0,  F:12, K:280},
  {k:"rotiss_white6",   name:"Rotisserie Chicken White (6 oz)",             cat:"Protein",P:48, C:0,  F:12, K:330},
  {k:"cod_6oz",         name:"Cod/Tilapia (cooked, 6 oz)",                  cat:"Protein",P:40, C:0,  F:4,  K:220},

  // Grains / Starches
  {k:"rice_jas_1c",     name:"Rice, Jasmine (cooked, 1 cup)",               cat:"Grain",  P:4,  C:45, F:0,  K:205},
  {k:"quinoa_1c",       name:"Quinoa (cooked, 1 cup)",                      cat:"Grain",  P:8,  C:40, F:4,  K:222},
  {k:"oats_half",       name:"Oats (dry, ½ cup)",                           cat:"Grain",  P:5,  C:27, F:3,  K:150},
  {k:"bread_whole",     name:"Whole Grain Bread (1 slice)",                 cat:"Grain",  P:4,  C:15, F:1,  K:80},
  {k:"ricecakes_3",     name:"Rice Cakes (3 units)",                        cat:"Grain",  P:3,  C:21, F:0,  K:105},

  // Fruit / Veg
  {k:"banana",          name:"Banana (1 medium)",                            cat:"Produce",P:1,  C:27, F:0,  K:105},
  {k:"blueberries_1c",  name:"Blueberries (1 cup)",                          cat:"Produce",P:1,  C:21, F:0,  K:85},
  {k:"apple_small",     name:"Apple (small)",                                cat:"Produce",P:0,  C:20, F:0,  K:80},
  {k:"peas_1c",         name:"Peas (1 cup)",                                 cat:"Produce",P:8,  C:21, F:0,  K:134},
  {k:"broccoli_1c",     name:"Broccoli (1 cup)",                             cat:"Produce",P:3,  C:6,  F:0,  K:31},
  {k:"asparagus_1c",    name:"Asparagus (1 cup)",                            cat:"Produce",P:3,  C:5,  F:0,  K:27},
  {k:"greenbeans_1c",   name:"Green Beans (1 cup)",                          cat:"Produce",P:2,  C:7,  F:0,  K:31},

  // Fats / Extras
  {k:"walnuts_1oz",     name:"Walnuts (1 oz)",                               cat:"Fats",   P:4,  C:4,  F:18, K:185},
  {k:"almonds_1oz",     name:"Almonds (1 oz)",                               cat:"Fats",   P:6,  C:6,  F:14, K:165},
  {k:"pb_1tbsp",        name:"Peanut Butter (1 tbsp)",                       cat:"Fats",   P:4,  C:3,  F:8,  K:95},
  {k:"olive_1tsp",      name:"Olive Oil (1 tsp)",                            cat:"Fats",   P:0,  C:0,  F:5,  K:45},
];

// ====== TARGETS BY DAY TYPE ======
const TARGETS = {
  training: {P:200, C:340, F:85, K:3000, label:'TRAINING', pill:'train'},
  rest:     {P:200, C:260, F:85, K:2700, label:'REST',     pill:'rest'},
  busy:     {P:200, C:320, F:85, K:2900, label:'BUSY',     pill:'busy'}
};

// ====== DEFAULT MEALS ======
const DEFAULT_MEALS = [
  { 
    key:"breakfast", 
    name:"🥤 Breakfast", 
    rows:[
      {food:"kefir_1c",serv:1},
      {food:"greek2_3q",serv:1},
      {food:"cottage2_half",serv:1},
      {food:"oats_half",serv:1}
    ]
  },
  { 
    key:"snack1", 
    name:"🥗 Snack 1", 
    rows:[
      {food:"skyr_1c",serv:1},
      {food:"blueberries_1c",serv:1},
      {food:"walnuts_1oz",serv:1}
    ]
  },
  { 
    key:"lunch", 
    name:"🍗 Lunch", 
    rows:[
      {food:"chicken_3oz",serv:2},
      {food:"rice_jas_1c",serv:1.5},
      {food:"broccoli_1c",serv:1},
      {food:"olive_1tsp",serv:2}
    ]
  },
  { 
    key:"snack2", 
    name:"🥪 Snack 2", 
    rows:[
      {food:"turkey_3oz",serv:1},
      {food:"bread_whole",serv:1},
      {food:"apple_small",serv:1}
    ]
  },
  { 
    key:"dinner", 
    name:"🐟 Dinner", 
    rows:[
      {food:"salmon_5oz",serv:1},
      {food:"quinoa_1c",serv:1},
      {food:"asparagus_1c",serv:1},
      {food:"olive_1tsp",serv:1}
    ]
  },
  { 
    key:"evening", 
    name:"🌙 Evening", 
    rows:[
      {food:"fairlife_1c",serv:1},
      {food:"ricecakes_3",serv:1},
      {food:"pb_1tbsp",serv:1}
    ]
  }
];

// ====== STATE ======
let state = {
  dayType: "training",
  meals: JSON.parse(JSON.stringify(DEFAULT_MEALS))
};

// ====== HELPERS ======
function foodByKey(k) {
  return FOOD_DB.find(f => f.k === k);
}

function macrosFor(k, serv = 1) {
  const f = foodByKey(k);
  if (!f) return {P:0, C:0, F:0, K:0};
  return {
    P: f.P * serv,
    C: f.C * serv,
    F: f.F * serv,
    K: f.K * serv
  };
}

function sum(arr, prop) {
  return arr.reduce((a, b) => a + (b[prop] || 0), 0);
}

function fmtRem(v, unit = 'g') {
  const n = Math.round(v);
  if (n === 0) return `0 ${unit}`;
  if (n < 0) return `${Math.abs(n)} ${unit} over`;
  return `${n} ${unit}`;
}

function bar(sel, pct) {
  const el = document.querySelector(sel);
  if (el) {
    const clamped = Math.max(0, Math.min(100, pct || 0));
    el.style.width = clamped + '%';
  }
}

// ====== RENDER FUNCTIONS ======
function buildFoodDropdown(selectedKey, mealIdx, rowIdx) {
  const wrap = document.createElement('div');
  wrap.className = 'picker';

  const select = document.createElement('select');
  select.setAttribute('aria-label', 'Food');

  // Group foods by category
  const categories = {};
  FOOD_DB.forEach(f => {
    if (!categories[f.cat]) categories[f.cat] = [];
    categories[f.cat].push(f);
  });

  // Build optgroups
  Object.keys(categories).forEach(cat => {
    const optgroup = document.createElement('optgroup');
    optgroup.label = cat;

    categories[cat].forEach(f => {
      const option = document.createElement('option');
      option.value = f.k;
      option.textContent = f.name;
      if (f.k === selectedKey) option.selected = true;
      optgroup.appendChild(option);
    });

    select.appendChild(optgroup);
  });

  select.addEventListener('change', () => {
    state.meals[mealIdx].rows[rowIdx].food = select.value;
    updateMacroDisplay(mealIdx, rowIdx);
    updateMealTotals(mealIdx);
    updateDailyTotals();
    saveLocal();
  });

  wrap.appendChild(select);
  return wrap;
}

function buildStepper(servVal, mealIdx, rowIdx) {
  const s = document.createElement('div');
  s.className = 'stepper';

  const minus = document.createElement('button');
  minus.className = 'pm';
  minus.textContent = '−';
  minus.type = 'button';

  const inp = document.createElement('input');
  inp.type = 'number';
  inp.step = '0.25';
  inp.min = '0';
  inp.value = servVal;

  const plus = document.createElement('button');
  plus.className = 'pm';
  plus.textContent = '+';
  plus.type = 'button';

  const unit = document.createElement('span');
  unit.className = 'u';
  unit.textContent = 'serv';

  const updateServing = (newVal) => {
    inp.value = newVal.toFixed(2).replace(/\.00$/, '').replace(/\.25$/, '.25').replace(/\.50$/, '.5').replace(/\.75$/, '.75');
    state.meals[mealIdx].rows[rowIdx].serv = parseFloat(inp.value) || 0;
    updateMacroDisplay(mealIdx, rowIdx);
    updateMealTotals(mealIdx);
    updateDailyTotals();
    saveLocal();
  };

  minus.addEventListener('click', () => {
    let v = parseFloat(inp.value) || 0;
    updateServing(Math.max(0, v - 0.25));
  });

  plus.addEventListener('click', () => {
    let v = parseFloat(inp.value) || 0;
    updateServing(v + 0.25);
  });

  inp.addEventListener('input', () => {
    state.meals[mealIdx].rows[rowIdx].serv = parseFloat(inp.value) || 0;
    updateMacroDisplay(mealIdx, rowIdx);
    updateMealTotals(mealIdx);
    updateDailyTotals();
    saveLocal();
  });

  s.appendChild(minus);
  s.appendChild(inp);
  s.appendChild(plus);
  s.appendChild(unit);
  return {wrap: s, input: inp};
}

function render() {
  const mealsEl = document.getElementById('meals');
  mealsEl.innerHTML = '';

  state.meals.forEach((m, mi) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.meal = m.key;
    card.dataset.mealIdx = mi;

    const h = document.createElement('h3');
    h.textContent = m.name;
    card.appendChild(h);

    const rowsWrap = document.createElement('div');
    rowsWrap.className = 'rows';

    m.rows.forEach((r, ri) => {
      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.row = ri;

      // Food dropdown
      const dropdown = buildFoodDropdown(r.food, mi, ri);

      // Stepper
      const step = buildStepper(r.serv ?? 1, mi, ri);

      // Macros display
      const macros = document.createElement('div');
      macros.className = 'sub';
      macros.dataset.mealIdx = mi;
      macros.dataset.rowIdx = ri;
      const M = macrosFor(r.food, r.serv);
      macros.textContent = `${M.P.toFixed(1)}P • ${M.C.toFixed(1)}C • ${M.F.toFixed(1)}F • ${Math.round(M.K)} kcal`;

      // Delete button
      const del = document.createElement('button');
      del.className = 'btn remove';
      del.type = 'button';
      del.title = 'Remove';
      del.setAttribute('aria-label', 'Remove food');
      del.textContent = '✕';
      del.addEventListener('click', () => {
        m.rows.splice(ri, 1);
        render();
        saveLocal();
      });

      row.appendChild(dropdown);
      row.appendChild(step.wrap);
      row.appendChild(macros);
      row.appendChild(del);
      rowsWrap.appendChild(row);
    });

    // Add row button
    const add = document.createElement('button');
    add.className = 'btn add-row';
    add.type = 'button';
    add.textContent = '+ Add Food';
    add.addEventListener('click', () => {
      m.rows.push({food: FOOD_DB[0].k, serv: 1});
      render();
      saveLocal();
    });

    // Per-meal footer (fat badge)
    const foot = document.createElement('div');
    foot.style.display = 'flex';
    foot.style.justifyContent = 'space-between';
    foot.style.alignItems = 'center';
    foot.style.marginTop = '6px';

    const fatBadge = document.createElement('span');
    fatBadge.className = 'chip';
    fatBadge.dataset.mealIdx = mi;
    
    // Calculate meal fat total
    let mealFat = 0;
    m.rows.forEach(r => {
      const M = macrosFor(r.food, r.serv);
      mealFat += M.F;
    });
    
    fatBadge.textContent = `Fat ${mealFat.toFixed(1)} g`;
    fatBadge.classList.add(mealFat <= 20 ? 'ok' : mealFat <= 25 ? 'warn' : 'bad');

    const hint = document.createElement('span');
    hint.className = 'fat-note';
    hint.innerHTML = 'Target ≤ <b>20g</b>';

    foot.appendChild(fatBadge);
    foot.appendChild(hint);

    card.appendChild(rowsWrap);
    card.appendChild(add);
    card.appendChild(foot);
    mealsEl.appendChild(card);
  });

  updateDailyTotals();
}

// ====== UPDATE FUNCTIONS ======
function updateMacroDisplay(mealIdx, rowIdx) {
  const card = document.querySelector(`[data-meal-idx="${mealIdx}"]`);
  if (!card) return;
  
  const row = card.querySelectorAll('.row')[rowIdx];
  if (!row) return;
  
  const macroEl = row.querySelector('.sub');
  if (!macroEl) return;
  
  const r = state.meals[mealIdx].rows[rowIdx];
  const M = macrosFor(r.food, r.serv);
  macroEl.textContent = `${M.P.toFixed(1)}P • ${M.C.toFixed(1)}C • ${M.F.toFixed(1)}F • ${Math.round(M.K)} kcal`;
}

function updateMealTotals(mealIdx) {
  const card = document.querySelector(`[data-meal-idx="${mealIdx}"]`);
  if (!card) return;
  
  const m = state.meals[mealIdx];
  let mealFat = 0;
  
  m.rows.forEach(r => {
    const M = macrosFor(r.food, r.serv);
    mealFat += M.F;
  });
  
  const fatBadge = card.querySelector('.chip');
  if (fatBadge) {
    fatBadge.textContent = `Fat ${mealFat.toFixed(1)} g`;
    fatBadge.classList.remove('ok', 'warn', 'bad');
    fatBadge.classList.add(mealFat <= 20 ? 'ok' : mealFat <= 25 ? 'warn' : 'bad');
  }
}

function updateDailyTotals() {
  // Calculate daily totals
  let totalP = 0, totalC = 0, totalF = 0, totalK = 0;
  
  state.meals.forEach(m => {
    m.rows.forEach(r => {
      const M = macrosFor(r.food, r.serv);
      totalP += M.P;
      totalC += M.C;
      totalF += M.F;
      totalK += M.K;
    });
  });

  // Update display
  const totP = document.getElementById('totP');
  const totC = document.getElementById('totC');
  const totF = document.getElementById('totF');
  const totK = document.getElementById('totK');
  
  if (totP) totP.textContent = `${Math.round(totalP)} g`;
  if (totC) totC.textContent = `${Math.round(totalC)} g`;
  if (totF) totF.textContent = `${Math.round(totalF)} g`;
  if (totK) totK.textContent = `${Math.round(totalK)} kcal`;

  const T = TARGETS[state.dayType];
  bar('#barP', totalP / T.P * 100);
  bar('#barC', totalC / T.C * 100);
  bar('#barF', totalF / T.F * 100);
  bar('#barK', totalK / T.K * 100);
  
  const remP = document.getElementById('remP');
  const remC = document.getElementById('remC');
  const remF = document.getElementById('remF');
  const remK = document.getElementById('remK');
  
  if (remP) remP.textContent = `${fmtRem(T.P - totalP)} left`;
  if (remC) remC.textContent = `${fmtRem(T.C - totalC)} left`;
  if (remF) remF.textContent = `${fmtRem(T.F - totalF)} left`;
  if (remK) remK.textContent = `${fmtRem(T.K - totalK, 'kcal')} left`;
}

// ====== DAY TYPE ======
function applyDayType() {
  const t = TARGETS[state.dayType];
  
  const tgP = document.getElementById('tgP');
  const tgC = document.getElementById('tgC');
  const tgF = document.getElementById('tgF');
  const tgK = document.getElementById('tgK');
  const pill = document.getElementById('dayPill');
  const dayTypeSelect = document.getElementById('dayType');
  
  if (tgP) tgP.textContent = t.P;
  if (tgC) tgC.textContent = t.C;
  if (tgF) tgF.textContent = t.F;
  if (tgK) tgK.textContent = t.K;
  
  if (pill) {
    pill.textContent = t.label;
    pill.className = `pill ${t.pill}`;
  }
  
  if (dayTypeSelect) {
    dayTypeSelect.value = state.dayType;
  }
  
  updateDailyTotals();
  saveLocal();
}

// ====== PERSISTENCE ======
const SAVE_KEY = 'macro_planner_v3';

function saveLocal() {
  try {
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  } catch(e) {
    console.error('Failed to save to localStorage:', e);
  }
}

function loadLocal() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    if (parsed?.meals && parsed?.dayType) {
      state = {...state, ...parsed};
    }
  } catch(e) {
    console.error('Failed to load saved state:', e);
  }
}

function exportJSON() {
  const txt = JSON.stringify(state, null, 2);
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(txt)
      .then(() => alert('Copied current plan JSON to clipboard!'))
      .catch(() => {
        fallbackCopy(txt);
      });
  } else {
    fallbackCopy(txt);
  }
}

function fallbackCopy(txt) {
  const ta = document.createElement('textarea');
  ta.value = txt;
  ta.style.position = 'fixed';
  ta.style.top = '-9999px';
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand('copy');
    alert('Copied current plan JSON to clipboard!');
  } catch(e) {
    alert('Failed to copy. Please try again.');
  }
  document.body.removeChild(ta);
}

function downloadJSON() {
  const txt = JSON.stringify(state, null, 2);
  const blob = new Blob([txt], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const ts = new Date().toISOString().slice(0, 10);
  a.href = url;
  a.download = `meal-plan-${ts}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importJSON() {
  const txt = prompt('Paste plan JSON here:');
  if (!txt) return;
  try {
    const parsed = JSON.parse(txt);
    if (parsed?.meals) {
      state = {...state, ...parsed};
      render();
      applyDayType();
      alert('Plan imported successfully!');
    } else {
      alert('Invalid plan format');
    }
  } catch(e) {
    alert('Invalid JSON');
  }
}

function resetPlan() {
  if (!confirm('Reset to default meals? This will clear your current plan.')) return;
  state.meals = JSON.parse(JSON.stringify(DEFAULT_MEALS));
  render();
  saveLocal();
}

// ====== EVENT LISTENERS ======
function initEventListeners() {
  const exportBtn = document.getElementById('exportBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const importBtn = document.getElementById('importBtn');
  const resetBtn = document.getElementById('resetBtn');
  const saveBtn = document.getElementById('saveBtn');
  const clearSaveBtn = document.getElementById('clearSaveBtn');
  const dayType = document.getElementById('dayType');
  
  if (exportBtn) exportBtn.addEventListener('click', exportJSON);
  if (downloadBtn) downloadBtn.addEventListener('click', downloadJSON);
  if (importBtn) importBtn.addEventListener('click', importJSON);
  if (resetBtn) resetBtn.addEventListener('click', resetPlan);
  
  if (saveBtn) {
    saveBtn.addEventListener('click', () => {
      saveLocal();
      alert('Saved to browser storage!');
    });
  }
  
  if (clearSaveBtn) {
    clearSaveBtn.addEventListener('click', () => {
      if (confirm('Clear saved state? This cannot be undone.')) {
        localStorage.removeItem(SAVE_KEY);
        alert('Saved state cleared.');
      }
    });
  }
  
  if (dayType) {
    dayType.addEventListener('change', e => {
      state.dayType = e.target.value;
      applyDayType();
    });
  }
}

// ====== INITIALIZE ======
document.addEventListener('DOMContentLoaded', () => {
  loadLocal();
  
  // Set initial day type in dropdown
  const dayTypeSelect = document.getElementById('dayType');
  if (dayTypeSelect) {
    dayTypeSelect.value = state.dayType;
  }
  
  render();
  applyDayType();
  initEventListeners();
});
</script>
</body>
</html>
