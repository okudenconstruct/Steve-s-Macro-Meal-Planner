<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Steve's Macro Meal Planner</title>
<meta name="description" content="ADHD-optimized macro meal planner with food dropdowns, dynamic math, fat-per-meal badges, and daily targets.">
<style>
  /* ====== THEME ====== */
  :root{
    --bg:#111827;--panel:#1f2937;--panel-2:#0f172a;--ink:#ffffff;--muted:#9ca3af;
    --border:#374151;--accent:#60a5fa;--ok:#4ade80;--warn:#f59e0b;--bad:#ef4444;
    --train:#facc15;--rest:#34d399;--busy:#60a5fa;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{width:100%;height:100vh;overflow:hidden}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    background:var(--bg);color:var(--ink);padding:8px;
    display:flex;flex-direction:column;
  }
  .container{
    flex:1;
    max-width:100%;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .title{font-weight:800;text-align:center;margin:.15rem 0 .5rem;font-size:1.1rem}

  /* ====== TOOLBAR ====== */
  .toolbar{
    display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;justify-content:space-between;
    padding:.4rem;border:1px solid var(--border);border-radius:.5rem;
    background:var(--panel);margin-bottom:8px;
  }
  .toolbar .group{display:flex;gap:.4rem;align-items:center}
  .btn{padding:.35rem .6rem;border:1px solid var(--border);background:var(--panel);color:#fff;border-radius:.4rem;cursor:pointer;font-size:.85rem}
  .btn.primary{background:#3b82f6;border-color:#2563eb}
  .btn.ghost{background:transparent}
  .btn.danger{background:#ef4444;border-color:#dc2626}
  .pill{padding:.2rem .5rem;border-radius:999px;font-weight:700;font-size:.8rem}
  .pill.train{background:rgba(250,204,21,.15);border:1px solid #a16207;color:var(--train)}
  .pill.rest{background:rgba(52,211,153,.15);border:1px solid #047857;color:var(--rest)}
  .pill.busy{background:rgba(96,165,250,.15);border:1px solid #1d4ed8;color:var(--busy)}
  label.small{color:var(--muted);font-size:.8rem}

  /* ====== GRID LAYOUT ====== */
  .grid{
    display:grid;
    grid-template-columns:1fr 1fr 280px;
    gap:10px;
    flex:1;
    overflow:hidden;
  }
  .meals{
    grid-column:1 / span 2;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    overflow-y:auto;
    padding-right:4px;
  }

  /* ====== CARDS / ROWS ====== */
  .card{background:var(--panel);border:1px solid var(--border);border-radius:.5rem;padding:10px;height:fit-content}
  .card h3{font-size:.95rem;font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:.4rem}
  .rows{display:grid;gap:6px}
  .row{display:grid;grid-template-columns:minmax(180px,1fr) auto 1fr 36px; gap:6px; align-items:center}
  .row > *{min-width:0}
  .remove{justify-self:end;padding:.25rem .4rem;font-size:.9rem}
  .sub{color:var(--muted);font-size:.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chip{font-weight:600;padding:.15rem .4rem;border-radius:.3rem;font-size:.75rem}
  .chip.ok{background:rgba(74,222,128,.12);color:var(--ok);border:1px solid #16a34a}
  .chip.warn{background:rgba(245,158,11,.12);color:var(--warn);border:1px solid #b45309}
  .chip.bad{background:rgba(239,68,68,.12);color:var(--bad);border:1px solid #b91c1c}
  .add-row{margin-top:4px;font-size:.8rem}
  .fat-note{font-size:.75rem;color:var(--muted)}
  .fat-note b{color:#fff}

  /* Searchable picker + stepper */
  .picker{display:flex;gap:4px;align-items:center}
  .picker input[type="text"]{flex:1 1 auto;background:#fff;color:#111;border:1px solid #d1d5db;border-radius:.3rem;padding:.35rem;font-size:.8rem}
  .stepper{display:flex;align-items:center;gap:4px}
  .stepper input{width:60px;text-align:center;background:#fff;color:#111;border:1px solid #d1d5db;border-radius:.3rem;padding:.3rem;font-size:.8rem}
  .stepper .u{color:var(--muted);font-size:.75rem}
  .stepper .pm{width:26px;height:26px;border-radius:.3rem;border:1px solid var(--border);background:var(--panel-2);color:#fff;cursor:pointer;font-size:.8rem}

  select, input[type="number"]{background:#fff;color:#111;border:1px solid #d1d5db;border-radius:.3rem;padding:.35rem;font-size:.8rem}
  select:focus,input:focus, .picker input[type="text"]:focus{outline:none;box-shadow:0 0 0 2px var(--accent)}

  /* ====== SIDEBAR ====== */
  .sidebar{
    display:grid;
    gap:10px;
    height:100%;
    overflow-y:auto;
  }
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:.5rem;padding:10px}
  .totals h4{font-weight:800;margin-bottom:6px;font-size:.95rem}
  .kpi{display:grid;grid-template-columns:1fr auto; align-items:center; gap:6px; margin:6px 0}
  .kpi .num{font-weight:900}
  .bar{height:10px;background:#0b1324;border:1px solid #172554;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#3b82f6,#22c55e);width:0%}
  .remain{color:var(--muted);font-size:.75rem;text-align:right}

  .targets{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px}
  .targets div{background:var(--panel-2);border:1px solid var(--border);padding:4px;border-radius:.4rem;text-align:center}
  .targets strong{display:block;font-size:.95rem}
  .targets small{font-size:.7rem}

  .save-row{display:flex;gap:4px;flex-wrap:wrap}

  /* Scrollbar styling */
  ::-webkit-scrollbar{width:6px;height:6px}
  ::-webkit-scrollbar-track{background:var(--panel-2)}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  ::-webkit-scrollbar-thumb:hover{background:var(--accent)}
</style>
</head>
<body>
<div class="container">
  <div class="title">Steve's Macro Meal Planner</div>

  <div class="toolbar" role="toolbar" aria-label="Actions">
    <div class="group">
      <label class="small" for="dayType">Day Type</label>
      <select id="dayType" aria-label="Select day type">
        <option value="training">Training Day â€” 200P / 340C / 85F (~3000 kcal)</option>
        <option value="rest">Rest Day â€” 200P / 260C / 85F (~2700 kcal)</option>
        <option value="busy">Busy Day â€” 200P / 320C / 85F (~2900 kcal)</option>
      </select>
      <span id="dayPill" class="pill train" aria-live="polite">TRAINING</span>
    </div>
    <div class="group">
      <button class="btn ghost" id="importBtn" title="Paste JSON to load">Import</button>
      <button class="btn" id="exportBtn" title="Copy JSON to clipboard">Export</button>
      <button class="btn" id="downloadBtn" title="Download JSON file">Download</button>
      <button class="btn danger" id="resetBtn">Reset</button>
    </div>
  </div>

  <div class="grid">
    <!-- ===== MEALS COLUMN(S) ===== -->
    <div class="meals" id="meals" aria-live="polite"></div>

    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar" aria-label="Totals and Save">
      <div class="panel totals">
        <h4>Daily Totals</h4>

        <div class="kpi">
          <div><span style="color:var(--muted)">Protein</span><div class="bar"><span id="barP"></span></div></div>
          <div class="remain"><span id="totP">0 g</span><br><small id="remP">0 g left</small></div>
        </div>

        <div class="kpi">
          <div><span style="color:var(--muted)">Carbs</span><div class="bar"><span id="barC"></span></div></div>
          <div class="remain"><span id="totC">0 g</span><br><small id="remC">0 g left</small></div>
        </div>

        <div class="kpi">
          <div><span style="color:var(--muted)">Fat</span><div class="bar"><span id="barF"></span></div></div>
          <div class="remain"><span id="totF">0 g</span><br><small id="remF">0 g left</small></div>
        </div>

        <div class="kpi">
          <div><span style="color:var(--muted)">Calories</span><div class="bar"><span id="barK"></span></div></div>
          <div class="remain"><span id="totK">0 kcal</span><br><small id="remK">0 kcal left</small></div>
        </div>

        <div class="targets">
          <div><small style="color:var(--muted)">Target P</small><strong id="tgP">200</strong><small style="color:var(--muted)">g</small></div>
          <div><small style="color:var(--muted)">Target C</small><strong id="tgC">340</strong><small style="color:var(--muted)">g</small></div>
          <div><small style="color:var(--muted)">Target F</small><strong id="tgF">85</strong><small style="color:var(--muted)">g</small></div>
          <div><small style="color:var(--muted)">Target</small><strong id="tgK">3000</strong><small style="color:var(--muted)">kcal</small></div>
        </div>
      </div>

      <div class="panel">
        <div class="save-row">
          <button class="btn primary" id="saveBtn">Save to Browser</button>
          <button class="btn" id="clearSaveBtn">Clear Save</button>
        </div>
        <p style="color:var(--muted);font-size:.7rem;margin-top:4px">State stored in localStorage.</p>
      </div>

      <div class="panel">
        <b style="font-size:.85rem">Fat per meal</b>
        <p style="color:var(--muted);font-size:.7rem;margin-top:2px">Green â‰¤20g, amber 20-25g, red >25g</p>
      </div>
    </aside>
  </div>
</div>

<!-- global datalist for searchable foods -->
<datalist id="foodsList"></datalist>

<script>
/* =======================
   DATA: Food database
   ======================= */
const FOOD_DB = [
  // Dairy
  {k:"kefir_1c",        name:"Kefir (plain, 1 cup)",                        cat:"Dairy",  P:9,  C:12, F:3,  K:120},
  {k:"greek2_3q",       name:"Greek Yogurt 2% (Â¾ cup / 170g)",              cat:"Dairy",  P:15, C:6,  F:3,  K:120},
  {k:"cottage2_half",   name:"Cottage Cheese 2% (Â½ cup)",                   cat:"Dairy",  P:12, C:5,  F:2,  K:100},
  {k:"skyr_1c",         name:"Skyr (1 cup)",                                cat:"Dairy",  P:20, C:15, F:1,  K:150},
  {k:"fairlife_1c",     name:"Fairlife Milk (1 cup)",                        cat:"Dairy",  P:13, C:6,  F:2.5,K:80},
  {k:"whey_iso",        name:"Whey Isolate (1 scoop, optional)",            cat:"Dairy",  P:25, C:2,  F:1,  K:120},

  // Proteins
  {k:"chicken_3oz",     name:"Chicken Breast (cooked, 3 oz)",               cat:"Protein",P:26, C:0,  F:3,  K:140},
  {k:"turkey_3oz",      name:"Turkey Breast Deli (3 oz)",                   cat:"Protein",P:21, C:2,  F:1.5,K:110},
  {k:"salmon_5oz",      name:"Salmon (cooked, 5 oz)",                       cat:"Protein",P:34, C:0,  F:12, K:280},
  {k:"rotiss_white6",   name:"Rotisserie Chicken White (6 oz)",             cat:"Protein",P:48, C:0,  F:12, K:330},
  {k:"cod_6oz",         name:"Cod/Tilapia (cooked, 6 oz)",                  cat:"Protein",P:40, C:0,  F:4,  K:220},

  // Grains / Starches
  {k:"rice_jas_1c",     name:"Rice, Jasmine (cooked, 1 cup)",               cat:"Grain",  P:4,  C:45, F:0,  K:205},
  {k:"quinoa_1c",       name:"Quinoa (cooked, 1 cup)",                      cat:"Grain",  P:8,  C:40, F:4,  K:222},
  {k:"oats_half",       name:"Oats (dry, Â½ cup)",                           cat:"Grain",  P:5,  C:27, F:3,  K:150},
  {k:"bread_whole",     name:"Whole Grain Bread (1 slice)",                 cat:"Grain",  P:4,  C:15, F:1,  K:80},
  {k:"ricecakes_3",     name:"Rice Cakes (3 units)",                        cat:"Grain",  P:3,  C:21, F:0,  K:105},

  // Fruit / Veg
  {k:"banana",          name:"Banana (1 medium)",                            cat:"Produce",P:1,  C:27, F:0,  K:105},
  {k:"blueberries_1c",  name:"Blueberries (1 cup)",                          cat:"Produce",P:1,  C:21, F:0,  K:85},
  {k:"apple_small",     name:"Apple (small)",                                cat:"Produce",P:0,  C:20, F:0,  K:80},
  {k:"peas_1c",         name:"Peas (1 cup)",                                 cat:"Produce",P:8,  C:21, F:0,  K:134},
  {k:"broccoli_1c",     name:"Broccoli (1 cup)",                             cat:"Produce",P:3,  C:6,  F:0,  K:31},
  {k:"asparagus_1c",    name:"Asparagus (1 cup)",                            cat:"Produce",P:3,  C:5,  F:0,  K:27},
  {k:"greenbeans_1c",   name:"Green Beans (1 cup)",                          cat:"Produce",P:2,  C:7,  F:0,  K:31},

  // Fats / Extras
  {k:"walnuts_1oz",     name:"Walnuts (1 oz)",                               cat:"Fats",   P:4,  C:4,  F:18, K:185},
  {k:"almonds_1oz",     name:"Almonds (1 oz)",                               cat:"Fats",   P:6,  C:6,  F:14, K:165},
  {k:"pb_1tbsp",        name:"Peanut Butter (1 tbsp)",                       cat:"Fats",   P:4,  C:3,  F:8,  K:95},
  {k:"olive_1tsp",      name:"Olive Oil (1 tsp)",                            cat:"Fats",   P:0,  C:0,  F:5,  K:45},
];

/* ===== Targets by day type ===== */
const TARGETS = {
  training:{P:200,C:340,F:85,K:3000,label:'TRAINING',pill:'train'},
  rest    :{P:200,C:260,F:85,K:2700,label:'REST',    pill:'rest'},
  busy    :{P:200,C:320,F:85,K:2900,label:'BUSY',    pill:'busy'}
};

/* ===== Initial meal layout ===== */
const DEFAULT_MEALS = [
  { key:"breakfast", name:"ðŸ¥¤ Breakfast", rows:[
    {food:"kefir_1c",serv:1},{food:"greek2_3q",serv:1},{food:"cottage2_half",serv:1},{food:"oats_half",serv:1}
  ]},
  { key:"snack1", name:"ðŸ¥— Snack 1", rows:[
    {food:"skyr_1c",serv:1},{food:"blueberries_1c",serv:1},{food:"walnuts_1oz",serv:1}
  ]},
  { key:"lunch", name:"ðŸ— Lunch", rows:[
    {food:"chicken_3oz",serv:2},{food:"rice_jas_1c",serv:1.5},{food:"broccoli_1c",serv:1},{food:"olive_1tsp",serv:2}
  ]},
  { key:"snack2", name:"ðŸ¥ª Snack 2", rows:[
    {food:"turkey_3oz",serv:1},{food:"bread_whole",serv:1},{food:"apple_small",serv:1}
  ]},
  { key:"dinner", name:"ðŸŸ Dinner", rows:[
    {food:"salmon_5oz",serv:1},{food:"quinoa_1c",serv:1},{food:"asparagus_1c",serv:1},{food:"olive_1tsp",serv:1}
  ]},
  { key:"evening", name:"ðŸŒ™ Evening", rows:[
    {food:"fairlife_1c",serv:1},{food:"ricecakes_3",serv:1},{food:"pb_1tbsp",serv:1}
  ]}
];

/* =======================
   State
   ======================= */
let state = {
  dayType:"training",
  meals: JSON.parse(JSON.stringify(DEFAULT_MEALS))
};

const $ = sel => document.querySelector(sel);
const mealsEl = $('#meals');

/* Build global datalist */
const foodsList = document.getElementById('foodsList');
FOOD_DB.forEach(f=>{
  const opt = document.createElement('option');
  opt.value = f.name; // visible text
  opt.setAttribute('data-key', f.k); // not used by browser, kept for debugging
  foodsList.appendChild(opt);
});

/* Fast name->key map (case-insensitive exact match) */
const NAME_TO_KEY = new Map(FOOD_DB.map(f=>[f.name.toLowerCase(), f.k]));

/* =======================
   Rendering
   ======================= */
function buildFoodSearch(selectedKey){
  const f = FOOD_DB.find(x=>x.k===selectedKey) || FOOD_DB[0];
  const wrap = document.createElement('div');
  wrap.className='picker';

  const input = document.createElement('input');
  input.type='text';
  input.setAttribute('list','foodsList');
  input.value = f.name;
  input.setAttribute('aria-label','Food');
  input.dataset.key = f.k; // keep the current key in sync

  const tryCommit = ()=>{
    const raw = input.value.trim();
    if(!raw){ return; }
    const exact = NAME_TO_KEY.get(raw.toLowerCase());
    if(exact){
      // set key + emit change upstream
      if(input.dataset.key !== exact){
        input.dataset.key = exact;
        wrap.dispatchEvent(new CustomEvent('foodchange', {detail: exact, bubbles:true}));
      }
      // ensure normalized name text (capitalization, etc.)
      const nf = foodByKey(exact);
      if(nf && nf.name !== input.value) input.value = nf.name;
    }
  };

  // respond quickly as user picks from datalist
  input.addEventListener('input', tryCommit);
  input.addEventListener('change', tryCommit);
  input.addEventListener('blur', ()=>{
    // on blur, also allow unique prefix match to be forgiving
    let v = input.value.trim().toLowerCase();
    if(!v) return;
    let key = NAME_TO_KEY.get(v);
    if(!key){
      const candidate = FOOD_DB.find(x=>x.name.toLowerCase().startsWith(v));
      if(candidate) key = candidate.k;
    }
    if(key){
      const nf = foodByKey(key);
      input.value = nf.name;
      if(input.dataset.key !== key){
        input.dataset.key = key;
        wrap.dispatchEvent(new CustomEvent('foodchange', {detail:key, bubbles:true}));
      }
    }
  });

  wrap.appendChild(input);
  return wrap;
}

function buildStepper(servVal=1){
  const s = document.createElement('div'); 
  s.className='stepper';
  
  const minus = document.createElement('button'); 
  minus.className='pm'; 
  minus.textContent='âˆ’';
  
  const inp = document.createElement('input'); 
  inp.type='number'; 
  inp.step='0.25'; 
  inp.min='0'; 
  inp.value=servVal;
  
  const plus = document.createElement('button'); 
  plus.className='pm'; 
  plus.textContent='+';
  
  const unit = document.createElement('span'); 
  unit.className='u'; 
  unit.textContent='serv';

  minus.addEventListener('click', ()=>{ 
    let v=parseFloat(inp.value)||0; 
    v=Math.max(0, v-0.25); 
    inp.value=v.toFixed(2).replace(/\.00$/,''); 
    inp.dispatchEvent(new Event('input')); 
  });
  
  plus.addEventListener('click', ()=>{ 
    let v=parseFloat(inp.value)||0; 
    v=v+0.25; 
    inp.value=v.toFixed(2).replace(/\.00$/,''); 
    inp.dispatchEvent(new Event('input')); 
  });

  s.appendChild(minus); 
  s.appendChild(inp); 
  s.appendChild(plus); 
  s.appendChild(unit);
  return {wrap:s, input:inp};
}

function render(){
  mealsEl.innerHTML = '';
  
  state.meals.forEach((m,mi)=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.meal = m.key;

    const h = document.createElement('h3');
    h.textContent = m.name;
    card.appendChild(h);

    const rowsWrap = document.createElement('div');
    rowsWrap.className='rows';

    m.rows.forEach((r,ri)=>{
      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.row=ri;

      // food searchable picker
      const picker = buildFoodSearch(r.food);
      picker.addEventListener('foodchange', (ev)=>{ 
        r.food = ev.detail; 
        updateTotals(); 
        saveLocal(); 
      });

      // stepper
      const step = buildStepper(r.serv ?? 1);
      step.input.addEventListener('input', ()=>{ 
        r.serv = parseFloat(step.input.value)||0; 
        updateTotals(); 
        saveLocal(); 
      });

      // macros display (always visible)
      const macros = document.createElement('div'); 
      macros.className='sub'; 
      macros.textContent='â€”';

      // delete
      const del = document.createElement('button'); 
      del.className='btn remove'; 
      del.title='Remove'; 
      del.setAttribute('aria-label','Remove food'); 
      del.textContent='âœ•';
      del.addEventListener('click',()=>{ 
        m.rows.splice(ri,1); 
        render(); 
        updateTotals(); 
        saveLocal(); 
      });

      row.appendChild(picker);
      row.appendChild(step.wrap);
      row.appendChild(macros);
      row.appendChild(del);
      rowsWrap.appendChild(row);
    });

    // Add row button
    const add = document.createElement('button');
    add.className='btn add-row';
    add.textContent='+ Add Food';
    add.addEventListener('click',()=>{
      m.rows.push({food:FOOD_DB[0].k,serv:1});
      render(); 
      updateTotals(); 
      saveLocal();
    });

    // Per-meal footer (fat badge)
    const foot = document.createElement('div');
    foot.style.display='flex'; 
    foot.style.justifyContent='space-between'; 
    foot.style.alignItems='center'; 
    foot.style.marginTop='6px';

    const fatBadge = document.createElement('span'); 
    fatBadge.className='chip'; 
    fatBadge.textContent = 'Fat 0 g';
    
    const hint = document.createElement('span'); 
    hint.className='fat-note'; 
    hint.innerHTML = 'Target â‰¤ <b>20g</b>';

    foot.appendChild(fatBadge); 
    foot.appendChild(hint);

    card.appendChild(rowsWrap);
    card.appendChild(add);
    card.appendChild(foot);
    mealsEl.appendChild(card);
  });

  updateTotals();
}

/* =======================
   Math helpers
   ======================= */
function foodByKey(k){ 
  return FOOD_DB.find(f=>f.k===k); 
}

function macrosFor(k,serv=1){
  const f = foodByKey(k); 
  if(!f) return {P:0,C:0,F:0,K:0};
  return {
    P:f.P*serv, 
    C:f.C*serv, 
    F:f.F*serv, 
    K:f.K*serv
  };
}

function sum(arr,prop){ 
  return arr.reduce((a,b)=>a+(b[prop]||0),0); 
}

/* =======================
   Update UI numbers
   ======================= */
function updateTotals(){
  // Update meal rows macros (source of truth = r.food)
  document.querySelectorAll('.card').forEach((card,mi)=>{
    const m = state.meals[mi];
    let mealP=0, mealC=0, mealF=0, mealK=0;

    card.querySelectorAll('.row').forEach((row,ri)=>{
      const r = m.rows[ri];

      // keep the visible input synced with current key
      const input = row.querySelector('input[list="foodsList"]');
      const f = foodByKey(r.food) || FOOD_DB[0];
      if (input && input.value !== f.name) input.value = f.name;
      if (input && input.dataset.key !== f.k) input.dataset.key = f.k;

      const servInput = row.querySelector('.stepper input');
      const serv = parseFloat(servInput.value)||0;
      r.serv = serv;

      const M = macrosFor(r.food, serv);
      mealP += M.P; 
      mealC += M.C; 
      mealF += M.F; 
      mealK += M.K;

      // Always show macros
      const mac = row.querySelector('.sub');
      mac.textContent = `${M.P.toFixed(1)}P â€¢ ${M.C.toFixed(1)}C â€¢ ${M.F.toFixed(1)}F â€¢ ${Math.round(M.K)} kcal`;
    });

    // Update fat chip
    const chip = card.querySelector('.chip');
    chip.textContent = `Fat ${mealF.toFixed(1)} g`;
    chip.classList.remove('ok','warn','bad');
    if(mealF <= 20) chip.classList.add('ok');
    else if(mealF <= 25) chip.classList.add('warn');
    else chip.classList.add('bad');
  });

  // Calculate daily totals
  const totals = state.meals.flatMap(m=>m.rows).map(r=>macrosFor(r.food,r.serv));
  const P = sum(totals,'P'), 
        C = sum(totals,'C'), 
        F = sum(totals,'F'), 
        K = sum(totals,'K');

  $('#totP').textContent = `${Math.round(P)} g`;
  $('#totC').textContent = `${Math.round(C)} g`;
  $('#totF').textContent = `${Math.round(F)} g`;
  $('#totK').textContent = `${Math.round(K)} kcal`;

  const T = TARGETS[state.dayType];
  bar('#barP', P/T.P*100); 
  $('#remP').textContent = `${fmtRem(T.P-P)} left`;
  bar('#barC', C/T.C*100); 
  $('#remC').textContent = `${fmtRem(T.C-C)} left`;
  bar('#barF', F/T.F*100); 
  $('#remF').textContent = `${fmtRem(T.F-F)} left`;
  bar('#barK', K/T.K*100); 
  $('#remK').textContent = `${fmtRem(T.K-K,'kcal')} left`;
}

function fmtRem(v, unit='g'){
  const n = Math.round(v);
  if (n === 0) return `0 ${unit}`;
  if (n < 0) return `${Math.abs(n)} ${unit} over`;
  return `${n} ${unit}`;
}

function bar(sel, pct){
  const el = document.querySelector(sel);
  const clamped = Math.max(0, Math.min(100, pct||0));
  el.style.width = clamped + '%';
}

/* =======================
   Day type (targets + pill)
   ======================= */
function applyDayType(){
  const t = TARGETS[state.dayType];
  $('#tgP').textContent = t.P;
  $('#tgC').textContent = t.C;
  $('#tgF').textContent = t.F;
  $('#tgK').textContent = t.K;
  const pill = $('#dayPill');
  pill.textContent = t.label;
  pill.className = `pill ${t.pill}`;
  updateTotals(); 
  saveLocal();
}

/* =======================
   Persistence + import/export/download
   ======================= */
const SAVE_KEY = 'macro_planner_v3';

function saveLocal(){ 
  localStorage.setItem(SAVE_KEY, JSON.stringify(state)); 
}

function loadLocal(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw) return;
  try{
    const parsed = JSON.parse(raw);
    if(parsed?.meals && parsed?.dayType){
      state = {...state, ...parsed};
    }
  }catch(e){
    console.error('Failed to load saved state:', e);
  }
}

function exportJSON(){
  const txt = JSON.stringify(state, null, 2);
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(txt).then(()=>alert('Copied current plan JSON to clipboard.'));
  } else {
    const ta = document.createElement('textarea'); 
    ta.value = txt; 
    document.body.appendChild(ta); 
    ta.select();
    document.execCommand('copy'); 
    document.body.removeChild(ta); 
    alert('Copied current plan JSON to clipboard.');
  }
}

function downloadJSON(){
  const txt = JSON.stringify(state, null, 2);
  const blob = new Blob([txt], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const ts = new Date().toISOString().slice(0,10);
  a.href = url; 
  a.download = `meal-plan-${ts}.json`;
  document.body.appendChild(a); 
  a.click(); 
  a.remove(); 
  URL.revokeObjectURL(url);
}

function importJSON(){
  const txt = prompt('Paste plan JSON here:');
  if(!txt) return;
  try{ 
    const parsed = JSON.parse(txt);
    state = {...state, ...parsed}; 
    render(); 
    applyDayType(); 
    saveLocal(); 
  }
  catch(e){ 
    alert('Invalid JSON'); 
  }
}

function resetPlan(){
  if(!confirm('Reset to default meals?')) return;
  state.meals = JSON.parse(JSON.stringify(DEFAULT_MEALS));
  render(); 
  updateTotals(); 
  saveLocal();
}

/* =======================
   Event Listeners
   ======================= */
$('#exportBtn').addEventListener('click', exportJSON);
$('#downloadBtn').addEventListener('click', downloadJSON);
$('#importBtn').addEventListener('click', importJSON);
$('#resetBtn').addEventListener('click', resetPlan);
$('#saveBtn')?.addEventListener('click', ()=>{
  saveLocal();
  alert('Saved to browser storage!');
});
$('#clearSaveBtn')?.addEventListener('click', ()=>{ 
  localStorage.removeItem(SAVE_KEY); 
  alert('Saved state cleared.'); 
});
$('#dayType').addEventListener('change', e=>{ 
  state.dayType = e.target.value; 
  applyDayType(); 
});

/* =======================
   Initialize
   ======================= */
loadLocal();
render();
applyDayType();
</script>
</body>
</html>
